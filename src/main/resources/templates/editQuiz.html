<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <title>Edit Quiz</title>
</head>

<body class="bg-light">
  <div class="container py-5" style="max-width: 900px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="m-0">Edit Question</h1>
      <a class="btn btn-outline-secondary" th:href="@{/quizList}">Back</a>
    </div>

    <div id="alertBox"></div>

    <form id="editForm" class="card p-4 shadow-sm">
      <div class="mb-3">
        <label class="form-label">Question Text</label>
        <input id="questionText" class="form-control" type="text" required minlength="3" />
      </div>

      <div class="mb-3">
        <label class="form-label">Options (4)</label>
        <div class="row g-2">
          <div class="col-md-6"><input id="opt0" class="form-control" type="text" required /></div>
          <div class="col-md-6"><input id="opt1" class="form-control" type="text" required /></div>
          <div class="col-md-6"><input id="opt2" class="form-control" type="text" required /></div>
          <div class="col-md-6"><input id="opt3" class="form-control" type="text" required /></div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Correct Answer</label>
        <select id="answerSelect" class="form-select" required>
          <option value="">Chooseâ€¦</option>
          <option value="0">Option 1</option>
          <option value="1">Option 2</option>
          <option value="2">Option 3</option>
          <option value="3">Option 4</option>
        </select>
        <div class="form-text">Pick which option is correct.</div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a class="btn btn-outline-secondary" th:href="@{/quizList}">Cancel</a>
      </div>
    </form>
  </div>

  <script>
    const parts = window.location.pathname.split("/");
    const questionId = parseInt(parts[parts.length - 1], 10);

    const alertBox = document.getElementById("alertBox");
    function showAlert(type, msg) {
      alertBox.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${msg}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }

    function getOptions() {
      return [
        document.getElementById("opt0").value.trim(),
        document.getElementById("opt1").value.trim(),
        document.getElementById("opt2").value.trim(),
        document.getElementById("opt3").value.trim(),
      ];
    }

    async function loadQuestion() {
      const res = await fetch("/api/questions");
      if (!res.ok) {
        showAlert("danger", "Failed to load questions. Are you logged in as ADMIN?");
        return;
      }

      const questions = await res.json();
      const q = questions.find(x => x.id === questionId);

      if (!q) {
        showAlert("warning", `Question with id ${questionId} not found.`);
        document.getElementById("editForm").style.display = "none";
        return;
      }

      document.getElementById("questionText").value = q.questionText ?? "";
      document.getElementById("opt0").value = q.options?.[0] ?? "";
      document.getElementById("opt1").value = q.options?.[1] ?? "";
      document.getElementById("opt2").value = q.options?.[2] ?? "";
      document.getElementById("opt3").value = q.options?.[3] ?? "";

      // set dropdown based on current answer
      const opts = q.options ?? [];
      const idx = opts.findIndex(o => o === q.answer);
      document.getElementById("answerSelect").value = idx >= 0 ? String(idx) : "";
    }

    document.getElementById("editForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const options = getOptions();
      const ansIndexStr = document.getElementById("answerSelect").value;
      if (ansIndexStr === "") {
        showAlert("warning", "Choose the correct answer.");
        return;
      }
      const answer = options[parseInt(ansIndexStr, 10)];

      const payload = {
        id: questionId,
        questionText: document.getElementById("questionText").value.trim(),
        options,
        answer
      };

      const res = await fetch(`/api/questions/${questionId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (res.status === 204 || res.ok) {
        showAlert("success", "Question updated successfully.");
      } else if (res.status === 403) {
        showAlert("danger", "Forbidden: ADMIN only.");
      } else {
        showAlert("danger", "Failed to update question.");
      }
    });

    loadQuestion();
  </script>
</body>
</html>
